@page "/session-live"
@namespace GoldTracker.Mobile.Components.Pages.Sessions
@using Archery.Shared.Models

<MudContainer MaxWidth="MaxWidth.False" Class="pa-4 archery-container" Style="padding-bottom: 80px;">
    @if (SessionState.CurrentSession == null)
    {
        <MudAlert Severity="Severity.Info">No active session. Please start one from the Sessions page.</MudAlert>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" Class="mt-4" OnClick="@(() => Navigation.NavigateTo("/sessions"))">Go to Sessions</MudButton>
    }
    else
    {
        <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Class="mb-4">
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                <MudIconButton Icon="@Icons.Material.Filled.ArrowBack" Color="Color.Default" OnClick="GoBackToSessions" />
                <MudStack Spacing="0">
                    <MudText Typo="Typo.h5" Class="font-weight-bold">Current Session</MudText>
                    @if (!string.IsNullOrEmpty(SessionState.CurrentSession.Topic))
                    {
                        <MudText Typo="Typo.subtitle1" Color="Color.Secondary">@SessionState.CurrentSession.Topic</MudText>
                    }
                </MudStack>
            </MudStack>
        </MudStack>

        <!-- Summary Statistics -->
        <!-- Summary Statistics -->
        <div class="cursor-pointer" @onclick="NavigateToComprehensiveDetail">
            <MudPaper Class="pa-4 mb-4" Elevation="0" Style="background: linear-gradient(135deg, #182848 0%, #4b6cb7 100%); border-radius: 12px; color: white;">
                <MudGrid>
                    <MudItem xs="4" Class="d-flex flex-column align-center">
                        <MudText Typo="Typo.caption" Style="opacity: 0.8;">SCORE</MudText>
                        <MudText Typo="Typo.h4" Class="font-weight-bold">@SessionState.CurrentSession.TotalScore</MudText>
                    </MudItem>
                    <MudItem xs="4" Class="d-flex flex-column align-center">
                        <MudText Typo="Typo.caption" Style="opacity: 0.8;">ARROWS</MudText>
                        <MudText Typo="Typo.h4" Class="font-weight-bold">@SessionState.CurrentSession.TotalArrows</MudText>
                    </MudItem>
                    <MudItem xs="4" Class="d-flex flex-column align-center">
                        <MudText Typo="Typo.caption" Style="opacity: 0.8;">AVG</MudText>
                        <MudText Typo="Typo.h4" Class="font-weight-bold">@SessionState.CurrentSession.ArrowAverage.ToString("F1")</MudText>
                    </MudItem>
                </MudGrid>
            </MudPaper>
        </div>

        <!-- Score Sheet (Replaces Ends List) -->
        <MudText Typo="Typo.subtitle2" Class="mb-2 font-weight-bold">Score Sheet (@SessionState.CurrentSession.Ends.Count ends)</MudText>
        
        @if (!SessionState.CurrentSession.Ends.Any())
        {
            <MudPaper Class="pa-6 d-flex flex-column align-center justify-center mud-width-full" Elevation="0" Style="background: transparent; border: 1px dashed var(--mud-palette-lines-default);">
                <MudText Typo="Typo.body2" Align="Align.Center" Color="Color.Default" Style="opacity: 0.7;">No ends recorded yet.</MudText>
                <MudText Typo="Typo.caption" Align="Align.Center" Color="Color.Default" Style="opacity: 0.5;">Tap "Add End" to capture your first shots.</MudText>
            </MudPaper>
        }
        else
        {
            <MudPaper Elevation="0" Style="border-radius: 12px; border: 1px solid #eee; overflow: hidden; background: white;" Class="mb-4">
                <MudTable T="ScoreRow" Items="@_scoreSheet" Hover="true" Breakpoint="Breakpoint.None" Dense="true" Elevation="0" Class="score-sheet-table" Style="width: 100%;" OnRowClick="OnEndRowClick" RowClass="cursor-pointer">
                    <HeaderContent>
                        <MudTh Style="width: 10%; padding: 8px;">#</MudTh>
                        <MudTh Style="width: 20%; padding: 8px;">Time</MudTh>
                        <MudTh Style="width: 40%; padding: 8px;">Arrows</MudTh>
                        <MudTh Style="width: 15%; padding: 8px; text-align: right;">E.T.</MudTh>
                        <MudTh Style="width: 15%; padding: 8px; text-align: right;">R.T.</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd Style="padding: 8px;">@context.EndNumber</MudTd>
                        <MudTd Style="padding: 8px;">
                            <MudText Typo="Typo.caption" Color="Color.Default">@context.Timestamp.ToString("HH:mm")</MudText>
                        </MudTd>
                        <MudTd Style="padding: 8px;">
                                <div class="d-flex flex-wrap gap-1">
                                    @if (context.Arrows.Count > 3)
                                    {
                                        @foreach (var arrow in context.Arrows.Take(3))
                                        {
                                            <div class="score-chip" style="background: @(GetArrowHexColor(arrow.Points)); color: @(arrow.Points >= 9 ? "black" : "white")">
                                            @(arrow.Points == 100 ? "X" : arrow.Points.ToString())
                                            </div>
                                        }
                                        <div class="score-chip" style="background: #E0E0E0; color: #757575; font-size: 0.7rem;">
                                            +@(context.Arrows.Count - 3)
                                        </div>
                                    }
                                    else
                                    {
                                        @foreach (var arrow in context.Arrows)
                                        {
                                            <div class="score-chip" style="background: @(GetArrowHexColor(arrow.Points)); color: @(arrow.Points >= 9 ? "black" : "white")">
                                            @(arrow.Points == 100 ? "X" : arrow.Points.ToString())
                                            </div>
                                        }
                                    }
                                </div>
                        </MudTd>
                        <MudTd Style="padding: 8px; text-align: right; font-weight: bold;">@context.EndScore</MudTd>
                        <MudTd Style="padding: 8px; text-align: right; font-weight: bold; color: #3b82f6;">@context.RunningTotal</MudTd>
                    </RowTemplate>
                </MudTable>
            </MudPaper>

            <style>
                .score-chip {
                    width: 22px; height: 22px; border-radius: 4px; 
                    display: flex; align-items: center; justify-content: center; 
                    font-weight: 800; font-size: 0.75rem;
                    box-shadow: 0 1px 2px rgba(0,0,0,0.1);
                }
                .score-sheet-table .mud-table-head { background: #fcfcfc; border-bottom: 2px solid #eee; }
                .score-sheet-table .mud-table-cell { font-size: 0.85rem; }
            </style>
        }

        <!-- Bottom Actions -->
        <MudStack Row="true" Spacing="2" Class="mt-4 mb-2">
            <MudButton Variant="Variant.Outlined" Color="Color.Success" StartIcon="@Icons.Material.Filled.Check" OnClick="FinishSession" FullWidth="true" Class="py-3">
                Finish
            </MudButton>
            <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add" OnClick="AddEnd" FullWidth="true" Class="py-3" Style="flex-grow: 1.5;">
                Add End
            </MudButton>
        </MudStack>
    }
</MudContainer>
