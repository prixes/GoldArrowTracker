@page "/dataset-creation"

<MudContainer MaxWidth="MaxWidth.False" Class="pa-2 archery-container">

    @if (string.IsNullOrEmpty(_displayImageSrc))
    {
        <!-- Selection Screen -->
        <MudCard Elevation="0" Class="pa-4 archery-themed-card" Style="background: linear-gradient(135deg, var(--mud-palette-surface) 0%, var(--mud-palette-background-grey) 100%); border: 1px solid var(--mud-palette-lines-default); border-radius: 12px;">
            <MudCardHeader Class="pa-0 mb-4">
                <CardHeaderAvatar>
                    <MudAvatar Color="Color.Primary" Variant="Variant.Filled" Size="Size.Large">
                        <MudIcon Icon="@Icons.Material.Filled.Adjust" />
                    </MudAvatar>
                </CardHeaderAvatar>
                <CardHeaderContent>
                    <MudText Typo="Typo.h5" Class="font-weight-bold">Dataset Builder</MudText>
                    <MudText Typo="Typo.caption">Create the ultimate archery model</MudText>
                </CardHeaderContent>
            </MudCardHeader>
            <MudCardContent Class="pa-0">
                <MudText Typo="Typo.body2" Class="mb-4">Select an image to start annotating targets and arrows.</MudText>
                
                @if (_isLoading)
                {
                    <MudStack AlignItems="AlignItems.Center" Class="py-8">
                        <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
                        <MudText Typo="Typo.caption">Loading Assets...</MudText>
                    </MudStack>
                }
                else
                {
                    <MudStack Spacing="2">
                        <MudButton Variant="Variant.Filled" 
                                   Color="Color.Primary" 
                                   StartIcon="@Icons.Material.Filled.PhotoCamera" 
                                   OnClick="CapturePhotoAsync" 
                                   FullWidth="true" 
                                   Size="Size.Large" 
                                   Style="text-transform:none; border-radius: 8px;">
                            Capture Target
                        </MudButton>
                        <MudButton Variant="Variant.Outlined" 
                                   Color="Color.Primary" 
                                   StartIcon="@Icons.Material.Filled.PhotoLibrary" 
                                   OnClick="PickPhotoAsync" 
                                   FullWidth="true" 
                                   Size="Size.Large" 
                                   Style="text-transform:none; border-radius: 8px;">
                            Pick from Gallery
                        </MudButton>
                        <MudButton Variant="Variant.Text" 
                                   Color="Color.Default" 
                                   StartIcon="@Icons.Material.Filled.FolderOpen" 
                                   OnClick="BrowseFilesAsync" 
                                   FullWidth="true" 
                                   Size="Size.Medium" 
                                   Style="text-transform:none;">
                            Browse Local Files
                        </MudButton>
                    </MudStack>
                }
            </MudCardContent>
        </MudCard>
    }
    else
    {
        <MudPaper Class="image-section d-flex justify-center align-center" Elevation="0" Style="position: relative; width: 100%; max-height: 65vh; background-color: transparent; border-radius: 12px; overflow: hidden; touch-action: none; border: 2px solid var(--mud-palette-lines-default);">
            <img @ref="_imageElement" src="@_displayImageSrc" alt="image to annotate" style="max-width: 100%; max-height: 65vh; object-fit: contain; pointer-events: none; display: block;"/>
            <canvas @ref="_canvasElement" id="annotation-canvas" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; cursor: crosshair; touch-action: none;"></canvas>
        </MudPaper>

        <MudCard Elevation="0" Class="mt-2 pa-2 glass-panel-heavy archery-panel" Style="transition: all 0.3s ease;">
            <MudText Typo="Typo.caption" Align="Align.Center" Class="mb-2 d-block" Style="opacity: 0.7; font-weight: bold; text-transform: uppercase; letter-spacing: 0.5px;">
                — Select Object Marker First —
            </MudText>

            <MudStack AlignItems="AlignItems.Center" Spacing="2">
                <MudButton Variant="@(_selectedMode == "target" ? Variant.Filled : Variant.Outlined)" 
                           Color="Color.Primary" 
                           StartIcon="@Icons.Material.Filled.Adjust"
                           Size="Size.Medium"
                           Class="px-6"
                           Style="height: 40px; border-radius: 20px; text-transform: none; font-weight: bold; min-width: 140px;"
                           OnClick="@(() => SetSelectedMode("target"))">
                    Target Face
                </MudButton>
                
                <div class="d-flex flex-wrap gap-1 justify-center align-center">
                    @for (int i = 10; i >= 1; i--)
                    {
                        int score = i;
                        <MudButton Variant="@(_selectedMode == "arrow" && _selectedArrowScore == score ? Variant.Filled : Variant.Outlined)"
                                   Color="@GetScoreButtonColor(score)"
                                   Size="Size.Medium"
                                   Style="min-width: 44px; width: 44px; height: 44px; border-radius: 22px; padding: 0; font-weight: bold; font-size: 1.1rem;"
                                   OnClick="@(() => SetSelectedScore(score))">
                            @score
                        </MudButton>
                    }
                    <MudButton Variant="@(_selectedMode == "arrow" && _selectedArrowScore == 0 ? Variant.Filled : Variant.Outlined)" 
                               Color="@GetScoreButtonColor(0)" 
                               Size="Size.Medium"
                               Style="min-width: 44px; width: 44px; height: 44px; border-radius: 22px; padding: 0; font-weight: bold; font-size: 1.1rem;"
                               OnClick="@(() => SetSelectedScore(0))">
                        M
                    </MudButton>
                </div>
            </MudStack>

            <MudStack Row="true" Spacing="1" Class="mt-3">
                <MudButton Variant="Variant.Filled" Color="Color.Success" StartIcon="@Icons.Material.Filled.Save" OnClick="SaveAnnotationsAsync" Disabled="!_annotations.Any()" Size="Size.Medium" Style="flex: 1; height: 44px; border-radius: 22px; font-weight: bold; font-size: 0.9rem;">
                    Finish & Save
                </MudButton>
                <MudIconButton Icon="@Icons.Material.Filled.Undo" Color="Color.Warning" Variant="Variant.Outlined" OnClick="UndoLastAnnotation" Disabled="!_annotations.Any()" Style="width: 44px; height: 44px; border-radius: 22px;" Size="Size.Small" />
                <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" Variant="Variant.Outlined" OnClick="DeleteSelectedOrClear" Disabled="!_annotations.Any()" Style="width: 44px; height: 44px; border-radius: 22px;" Size="Size.Small" />
            </MudStack>
            
            <MudButton Variant="Variant.Text" Color="Color.Default" FullWidth="true" OnClick="Reset" Class="mt-1" Style="text-transform: none; opacity: 0.6; font-size: 0.75rem; min-height: 24px;">
                Cancel
            </MudButton>
        </MudCard>
    }
</MudContainer>
