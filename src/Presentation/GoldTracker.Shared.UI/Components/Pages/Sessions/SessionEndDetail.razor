@page "/session-end/{SessionId:guid}/{EndIndex:int}"
@namespace GoldTracker.Shared.UI.Components.Pages.Sessions
@using Archery.Shared.Models

<MudContainer MaxWidth="MaxWidth.False" Class="pa-4 archery-container">
    @if (_isLoading)
    {
        <MudProgressCircular Color="Color.Primary" Indeterminate="true" Class="align-self-center my-4" />
    }
    else if (_end == null)
    {
        <MudAlert Severity="Severity.Error">End not found.</MudAlert>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" Class="mt-4" OnClick="GoBack">Back</MudButton>
    }
    else
    {
        <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Class="mb-4">
            <MudIconButton Icon="@Icons.Material.Filled.ArrowBack" OnClick="GoBack" />
            <MudText Typo="Typo.h5" Class="font-weight-bold">End @_end.Index Detail</MudText>
            <MudStack Row="true" Spacing="0">
                <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" OnClick="ConfirmDelete" title="Delete End" />
                <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="Color.Primary" OnClick="EnterEditMode" title="Correct Detections" />
            </MudStack>
        </MudStack>

        <MudPaper Class="pa-0 mb-4 mt-2" Elevation="0" Style="border: 1px solid var(--mud-palette-lines-default); border-radius: 12px; overflow: hidden; background: #f5f5f5; aspect-ratio: 1; position: relative;">
            <img @ref="_photoImageElement" src="@($"data:image/jpeg;base64,{_annotatedImageBase64}")" alt="End Image" style="width: 100%; height: 100%; object-fit: contain; pointer-events: none;" />
            <canvas @ref="_photoCanvasElement" id="photo-results-canvas" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; cursor: zoom-in; touch-action: none;"></canvas>
        </MudPaper>

        <style>
            .mud-tabs-control-next, .mud-tabs-control-prev { display: none !important; }
        </style>

        <MudPaper Class="pa-4 mb-4" Elevation="0" Style="background: linear-gradient(135deg, #182848 0%, #4b6cb7 100%); border-radius: 20px; color: white; position: relative; overflow: hidden; min-height: 120px;">
            <!-- Better placed edit button in top-right of the card -->
            <MudIconButton Icon="@Icons.Material.Filled.Edit" 
                           Color="Color.Inherit" 
                           OnClick="EnterEditMode" 
                           Size="Size.Medium" 
                           Style="position: absolute; top: 8px; right: 8px; display: none;"
                           title="Correct Detections" />

            <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Style="height: 100%; padding-top: 8px;">
                <MudStack Spacing="0">
                    <MudText Typo="Typo.caption" Style="opacity: 0.7; letter-spacing: 1px; font-weight: bold;">TOTAL SCORE</MudText>
                    <MudText Typo="Typo.h2" Class="font-weight-bold" Style="line-height: 1;">@_end.Score</MudText>
                    <MudText Typo="Typo.caption" Style="opacity: 0.5; margin-top: 4px;">@_end.Timestamp.ToString("HH:mm")</MudText>
                </MudStack>
                
                <div style="width: 100px; height: 100px; padding-right: 8px;">
                    <svg viewBox="0 0 100 100" style="width: 100%; height: 100%; filter: drop-shadow(0 4px 8px rgba(0,0,0,0.3));">
                        <circle cx="50" cy="50" r="50" fill="#f8f9fa" stroke="#dee2e6" stroke-width="0.3" />
                        <circle cx="50" cy="50" r="40" fill="#263238" stroke="rgba(255,255,255,0.1)" stroke-width="0.3" />
                        <circle cx="50" cy="50" r="30" fill="#1e88e5" stroke="rgba(255,255,255,0.1)" stroke-width="0.3" />
                        <circle cx="50" cy="50" r="20" fill="#e53935" stroke="rgba(255,255,255,0.1)" stroke-width="0.3" />
                        <circle cx="50" cy="50" r="10" fill="#fdd835" stroke="rgba(0,0,0,0.1)" stroke-width="0.3" />
                        @foreach (var arrow in _end.Arrows)
                        {
                            var (x, y) = GetNormalizedArrowPosition(arrow);
                            <circle cx="@(50 + x * 50)" cy="@(50 + y * 50)" r="2" fill="cyan" stroke="white" stroke-width="0.5" />
                        }
                    </svg>
                </div>
            </MudStack>
        </MudPaper>

        <MudText Typo="Typo.subtitle2" Class="mb-2 font-weight-bold">Arrow Scores</MudText>
        <div class="d-flex flex-wrap gap-2">
            @foreach (var arrow in _end.Arrows.OrderByDescending(a => a.Points))
            {
                <MudChip T="string" Color="GetArrowColor(arrow.Points)" Variant="Variant.Filled" Size="Size.Medium" Style="font-weight: bold; min-width: 44px; margin: 0;">
                    @(arrow.Points == 100 ? "X" : arrow.Points.ToString())
                </MudChip>
            }
        </div>

    }
</MudContainer>
