@page "/settings"
@using GoldTracker.Mobile.Services
@inject IServerAuthService AuthService
@inject ISnackbar Snackbar

<MudContainer MaxWidth="MaxWidth.Small" Class="mt-4">
    <MudText Typo="Typo.h4" GutterBottom="true">Settings</MudText>

    <MudPaper Class="pa-4 mt-4">
        <MudText Typo="Typo.h6">Account</MudText>
        
        @if (AuthService.IsAuthenticated)
        {
            <MudAlert Severity="Severity.Success" Class="mt-2">Signed In</MudAlert>
            <MudButton Variant="Variant.Outlined" 
                       Color="Color.Error" 
                       Class="mt-2"
                       OnClick="SignOut">
                Sign Out
            </MudButton>
        }
        else
        {
            <MudText Class="mt-2 mb-4">Sign in to sync your sessions and data to the cloud.</MudText>
            <MudButton Variant="Variant.Filled" 
                       Color="Color.Primary" 
                       StartIcon="@Icons.Custom.Brands.Google"
                       OnClick="SignInWithGoogle">
                Sign in with Google
            </MudButton>
        }
    </MudPaper>

    <MudPaper Class="pa-4 mt-4">
        <MudText Typo="Typo.h6">Server Connection</MudText>
        <MudText Typo="Typo.body2" Class="mt-2">
            Status: @(AuthService.IsAuthenticated ? "Connected" : "Offline")
        </MudText>
@using GoldTracker.Shared.UI.Models
@if (AuthService.IsAuthenticated)
        {
             <div class="d-flex flex-column gap-2 mt-4">
                 @if (_isSyncing)
                 {
                     <MudPaper Class="pa-3 outlined" Outlined="true">
                        <MudText Typo="Typo.caption" Class="mb-1">Session Sync</MudText>
                        <MudProgressLinear Color="Color.Secondary" Value="@_sessionSyncProgress.Percentage" Class="my-2" Striped="true" Size="Size.Large" />
                        <MudText Typo="Typo.caption">@_sessionSyncProgress.Message</MudText>
                     </MudPaper>
                 }
                 else
                 {
                     <MudButton Variant="Variant.Filled" 
                               Color="Color.Secondary" 
                               StartIcon="@Icons.Material.Filled.Sync"
                               OnClick="SyncAllSessions">
                        Sync Sessions (Up/Down)
                    </MudButton>
                 }

                 @if (_isDatasetSyncing)
                 {
                     <MudPaper Class="pa-3 outlined mt-2" Outlined="true">
                        <MudText Typo="Typo.caption" Class="mb-1">Dataset Export Sync</MudText>
                        <MudProgressLinear Color="Color.Primary" Value="@_datasetSyncProgress.Percentage" Class="my-2" Striped="true" Size="Size.Large" />
                        <MudText Typo="Typo.caption">@_datasetSyncProgress.Message</MudText>
                     </MudPaper>
                 }
                 else
                 {
                     <MudButton Variant="Variant.Filled" 
                               Color="Color.Primary" 
                               StartIcon="@Icons.Material.Filled.CloudUpload"
                               OnClick="SyncDatasets">
                        Sync Processed Datasets (Export)
                    </MudButton>
                 }
             </div>
        }
    </MudPaper>
</MudContainer>

@using Microsoft.Extensions.Configuration
@inject IConfiguration Config

@using GoldTracker.Mobile.Services.Sessions
@using Archery.Shared.Services
@inject ISessionSyncService SessionSyncService
@inject ISessionService SessionService

@inject IDatasetSyncService DatasetSyncService

@code {
    private bool _isSyncing = false;
    private bool _isDatasetSyncing = false;
    
    // UI State for Progress
    private SyncProgress _sessionSyncProgress = SyncProgress.Empty;
    private SyncProgress _datasetSyncProgress = SyncProgress.Empty;

    private async Task SyncDatasets()
    {
        if (_isDatasetSyncing) return;
        _isDatasetSyncing = true;
        _datasetSyncProgress = new SyncProgress(0, "Starting export sync...");
        StateHasChanged();
        
        try
        {
            var p = new Progress<SyncProgress>(value => 
            {
                _datasetSyncProgress = value;
                StateHasChanged();
            });

            var count = await DatasetSyncService.SyncExportedDatasetsAsync(p);
            
            if (count > 0)
                Snackbar.Add($"Synced {count} dataset files successfully!", Severity.Success);
            else
                Snackbar.Add("No dataset files found to sync.", Severity.Info);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Dataset Sync Error: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isDatasetSyncing = false;
            _datasetSyncProgress = SyncProgress.Empty;
             StateHasChanged();
        }
    }

    private async Task SyncAllSessions()
    {
        if (_isSyncing) return;
        _isSyncing = true;
        _sessionSyncProgress = new SyncProgress(0, "Starting session sync...");
        StateHasChanged();
        
        try
        {
            IProgress<SyncProgress> progress = new Progress<SyncProgress>(value =>
            {
                _sessionSyncProgress = value;
                StateHasChanged();
            });

            progress.Report(new SyncProgress(0, "Analyzing local sessions..."));

            // 1. Upload Local Sessions
            var sessions = await SessionService.GetSessionsAsync();
            int successCount = 0;
            int total = sessions.Count;
            int current = 0;
            
            foreach(var session in sessions)
            {
                 current++;
                 // We don't want to overwrite the INNER progress of the image upload, 
                 // but we want to show overall session progress.
                 // Ideally we'd compose them, but for now let's just let the inner one report.
                 
                 // Create a sub-progress that scales to this session's slot? Too complex.
                 // Just pass the main progress, the user will see "Uploading image X/Y" flashing.
                 
                 var success = await SessionSyncService.SyncSessionAsync(session, progress);
                 if(success) successCount++;
            }
            
            // 2. Download Remote Sessions
            int importedCount = await SessionSyncService.SyncFromServerAsync(progress);

            if (successCount > 0 || importedCount > 0)
                Snackbar.Add($"Synced! Uploaded: {successCount}, Downloaded: {importedCount}", Severity.Success);
            else if (sessions.Count > 0)
                Snackbar.Add("All sessions synced.", Severity.Success);
            else
                Snackbar.Add("No sessions to sync.", Severity.Info);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Sync Error: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isSyncing = false;
            _sessionSyncProgress = SyncProgress.Empty;
            StateHasChanged();
        }
    }

    private async Task SignInWithGoogle()
    {
        try
        {
            var serverUrl = Config["Settings:ServerUrl"] ?? "http://10.0.2.2:5000";
            var authUrl = $"{serverUrl}/api/auth/login-redirect"; 
            var result = await WebAuthenticator.Default.AuthenticateAsync(
                new Uri(authUrl),
                new Uri("goldtracker://")
            );

            // The WebAuthenticator parses the fragment/query into result.AccessToken if the key is 'access_token'
            if (!string.IsNullOrEmpty(result?.AccessToken))
            {
                await AuthService.SetAccessTokenAsync(result.AccessToken);
                Snackbar.Add("Successfully Signed In", Severity.Success);
                StateHasChanged();
            }
            else
            {
                 Snackbar.Add("No token received from login", Severity.Warning);
            }
        }
        catch (TaskCanceledException)
        {
             Snackbar.Add("Sign in canceled.", Severity.Info);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
    }

    private async Task SignOut()
    {
        await AuthService.LogoutAsync();
        Snackbar.Add("Signed Out", Severity.Info);
        StateHasChanged();
    }

    protected override async Task OnInitializedAsync()
    {
        // Try to restore session on load
        await AuthService.InitializeAsync();
    }
}
